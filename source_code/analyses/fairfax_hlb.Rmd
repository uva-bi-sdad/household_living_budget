---
title: "General Model - Household Living Budget - HLB"
author: "cm"
date: "6/03/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Start fresh
```{r}
rm(list=ls())
```

# Libraries
```{r}
#install.packages("ipumsr")
library(ipumsr)
#install.packages("tidyverse")
#library(tidyverse)
library(survival)
library(ggfortify)
library(dplyr)
library(readxl)
library(readr)
library(reshape2)
library(tidyr)
```

#  ######################## 1 DETAILS: Specify the fips code for the State and county ########################
```{r}
state_name <- "va"

county_fips <- 51059  #Fairfax County, VA 

county_name <- "Fairfax County"

counties_shared_puma <- c(51059, 51610, 51600) #PUMAS include Fairfax County, Fairfax city and Falls Church

name_files <- "fairfax"
```


# Household (HH) configuration by PUMA becomes HH configuration by tract
```{r}
#Load data from ipums
#ddi_2020_5year <- read_ipums_ddi("~/git/household_living_budget/data/demographic/acs_puma/fairfax_va_acs_puma_households_2020.xml")

#1 URLs of raw data files
#url xml file
url_xml <- "https://raw.githubusercontent.com/uva-bi-sdad/household_living_budget/main/data/demographic/acs_puma/fairfax_va_acs_puma_households_2020.xml"
#url gz file with data
url_gz <- "https://github.com/uva-bi-sdad/household_living_budget/raw/main/data/demographic/acs_puma/fairfax_va_acs_puma_households_2020.dat.gz" 

#2. download files
download.file(url_xml,'fairfax_va_acs_puma_households_2020.xml')
download.file(url_gz,'fairfax_va_acs_puma_households_2020.dat.gz')

#3. read xml to obtain key to data
ddi_2020_5year <- read_ipums_ddi('fairfax_va_acs_puma_households_2020.xml')

#4. rename file with appropiate name
ddi_2020_5year$file_name <- "fairfax_va_acs_puma_households_2020.dat"

#read data 
data <- read_ipums_micro(ddi_2020_5year)

#Using data from ipums
# Select only PUMAS for Fairfax County, VA
list_puma <- c(59301, 59302, 59303, 59304, 59305, 59306, 59307, 59308, 59309) 

# Separate no income (9999999) and negative income reported
data_fairfax <- data %>% filter(PUMA %in% list_puma) %>% filter(HHINCOME!=9999999) %>% filter( HHINCOME>0)

#NEW Income increase
rate_income_increase <- 0.0326 #0.0326  #0.05  #
#rate_income_increase <- 0.036

#Information from 2020.  Update to 2022: adjust 2 years
data_fairfax <- data_fairfax %>% mutate(HHINCOME = HHINCOME*(1+rate_income_increase)^2 )

# Income category: 9 brackets
data_fairfax$income_cat <- cut(data_fairfax$HHINCOME,
                               breaks= c(0,  14999, 24999, 34999, 49999, 74999, 99999, 149999, 199999, 10000000),
                               labels=c('Less than $15,000',
                                        '$15,000 to $24,999',              
                                        '$25,000 to $34,999',
                                        '$35,000 to $49,999',
                                        '$50,000 to $74,999',
                                        '$75,000 to $99,999',
                                        '$100,000 to $149,999',
                                        '$150,000 to $199,999',
                                        '$200,000 or more')
                               )


# recategorize hhsize
data_fairfax$fam_recode <- ifelse(data_fairfax$FAMSIZE >= 5, 5, data_fairfax$FAMSIZE )

# Recategorize age
data_fairfax <- data_fairfax %>% dplyr::mutate(
                              id_age =
                              case_when( AGE < 1 ~ 'infant',
                                        1 <= AGE & AGE < 3 ~ 'toddler',
                                        3 <= AGE & AGE < 5 ~ 'preschooler',
                                        5 <= AGE & AGE < 11 ~ 'schooler',
                                        11 <= AGE & AGE < 18 ~ 'teenager',
                                        18 <= AGE ~ 'adult')
                              )


# Categorize HouseHold Size - members in hh
data_fairfax <- data_fairfax %>% group_by(SERIAL) %>% mutate(hh_recode_init=n()) %>% mutate(hh_recode=ifelse(hh_recode_init>=5, 5, hh_recode_init) )

# HOUSEHOLD counts
fairfax_matrix_counts <- data_fairfax %>% group_by(PUMA, SERIAL, income_cat, hh_recode, id_age ) %>% summarise( num=n())

#Household CONFIGURATION
hh_config <- fairfax_matrix_counts %>% pivot_wider(names_from = id_age, values_from = num)

#replace NA for 0
hh_config$adult[is.na(hh_config$adult)] <- 0
hh_config$schooler[is.na(hh_config$schooler)] <- 0
hh_config$preschooler[is.na(hh_config$preschooler)] <- 0
hh_config$infant[is.na(hh_config$infant)] <- 0
hh_config$teenager[is.na(hh_config$teenager)] <- 0
hh_config$toddler[is.na(hh_config$toddler)] <- 0

# Household Income
fairfax_hh_income <- data_fairfax %>% group_by(SERIAL) %>% summarise( hhincome=first(HHINCOME))
hh_config <- hh_config %>% left_join(fairfax_hh_income, by='SERIAL')

# Total pop - HHWT
fairfax_hh_pop <- data_fairfax %>% group_by(SERIAL) %>% summarise( pop=first(HHWT))
hh_config <- hh_config %>% left_join(fairfax_hh_pop, by='SERIAL')

#general numbers hhconfi
sum(hh_config$pop)
fam_puma <- hh_config %>% group_by(PUMA) %>% summarise(hhtotal=sum(pop))

#IDENTIFIER household composition
hh_config <- hh_config %>% mutate(hh_compos = paste0(adult, teenager, schooler, preschooler, toddler, infant))

#summary household configurations per puma 
summary_hh_config_puma <- hh_config %>% group_by(PUMA, hh_compos) %>% summarise( num_hh = sum(pop))

#number of hh combinations per puma
table(summary_hh_config_puma$PUMA)


```

#matrix of household (hh) composition
```{r}
#household composition by puma, income cat, hhsize and composition. 
matrix_hh_compos <- hh_config %>% group_by(PUMA, income_cat, hh_size=hh_recode, hh_compos) %>% summarise(hh_num = sum(pop))

#proportion
matrix_hh_compos <- matrix_hh_compos %>% group_by(PUMA, income_cat, hh_size) %>% mutate(hh_num_puma = sum(hh_num, na.rm = TRUE)) %>% mutate(hh_num_puma_prop = hh_num/hh_num_puma)
```

# Crosswalks Census Tracts - PUMA
```{r}
#source https://www.census.gov/programs-surveys/geography/guidance/geo-areas/pumas.html
#source tallies https://www2.census.gov/geo/docs/maps-data/data/geo_tallies2020/tallies_by_state/Virginia_51.txt 

puma_ct <- read_delim("~/git/household_living_budget/data/demographic/crosswalks/2010_Census_Tract_to_2010_PUMA.txt", delim = ",")
puma_ct_20 <- read_delim("~/git/household_living_budget/data/demographic/crosswalks/2020_Census_Tract_to_2020_PUMA.txt", delim = ",")

# crosswalk for Fairfax County only
puma_ct_fairfax <- puma_ct %>% filter(STATEFP=='51', COUNTYFP== '059')

#puma_ct_fairfax_20 <- puma_ct_20 %>% filter(STATEFP=='51', COUNTYFP== '059')

puma_ct_fairfax_20_county <- puma_ct_20 %>% filter(STATEFP=='51', COUNTYFP== '059')
puma_ct_fairfax_20_city <- puma_ct_20 %>% filter(STATEFP=='51', COUNTYFP== '610')
puma_ct_fairfax_20_fallschurch <- puma_ct_20 %>% filter(STATEFP=='51', COUNTYFP== '600')

puma_ct_fairfax_20 <- rbind(puma_ct_fairfax_20_county, puma_ct_fairfax_20_city, puma_ct_fairfax_20_fallschurch)

#puma_ct_fairfax_2 <- puma_ct_fairfax %>% head(2)
puma_ct_fairfax$fips <- paste0(puma_ct_fairfax$STATEFP, puma_ct_fairfax$COUNTYFP, puma_ct_fairfax$TRACTCE )
puma_ct_fairfax_20$fips <- paste0(puma_ct_fairfax_20$STATEFP, puma_ct_fairfax_20$COUNTYFP, puma_ct_fairfax_20$TRACTCE )

#comparison
compare_puma_ct <- puma_ct_fairfax_20 %>% left_join(puma_ct_fairfax, by='fips')
table(compare_puma_ct$PUMA5CE.x, compare_puma_ct$PUMA5CE.y)
equivalence <-  compare_puma_ct %>% group_by(PUMA5CE.x) %>% summarise(equiv=first(PUMA5CE.y))

#rewrite categories of puma_ct_fairfax_20 (274 tracts) to match puma_ct_fairfax (258 tracts)
names(puma_ct_fairfax_20)[4] <- 'PUMA5CE_20'

puma_ct_fairfax_20 <- puma_ct_fairfax_20 %>% mutate(PUMA5CE= case_when(PUMA5CE_20 == '05901' ~ '59309',
                                                                       PUMA5CE_20 == '05902' ~ '59307', 
                                                                       PUMA5CE_20 == '05904' ~ '59305', 
                                                                       PUMA5CE_20 == '05905' ~ '59304', 
                                                                       PUMA5CE_20 == '05906' ~ '59306', 
                                                                       PUMA5CE_20 == '05907' ~ '59301', 
                                                                       PUMA5CE_20 == '05908' ~ '59302', 
                                                                       PUMA5CE_20 == '60001' ~ '59303', 
                                                                       PUMA5CE_20 == '61001' ~ '59308'
                                                      ) )

```

#  ######################## 2 Household Living Budget Components - HLB  ########################

# 2.1 Exercise at the household level

# Food Cost 
```{r}
#source:
#https://www.fns.usda.gov/cnpp/usda-food-plans-cost-food-reports-monthly-reports
#https://fns-prod.azureedge.us/sites/default/files/media/file/CostofFoodAug2022LowModLib.pdf
#adjustmen Feeding America
#https://map.feedingamerica.org/county/2020/overall/virginia

#data counties VA
# food_cost_adj <- read_excel("~/git/household_living_budget/data/household_living_budget/food/va_ct_usda_sep22_adjusted_low_cost_meal_plan_costs.xlsx")
food_cost_adj <- read_excel("~/git/household_living_budget/data/household_living_budget/food/va_ct_feeding_america_map_meal_gap_2022SEP.xlsx")

#data USDA USA
# usda_meal_plan_sep2022 <- read_csv("~/git/household_living_budget/data/household_living_budget/food/usda_meal_plan_sep2022.csv", skip = 1)
usda_meal_plan_sep2022 <- read_csv("~/git/household_living_budget/data/household_living_budget/food/national_usda_meal_plans_2022SEP.csv", skip = 1)

#data USDA categories and cost
usda_low_cost_meal <- usda_meal_plan_sep2022 %>% select(group=`...2`, monthly_cost=`Low-cost...6`) %>% filter( !is.na(monthly_cost)) %>% filter(monthly_cost!= 'plan')

#remove $
usda_low_cost_meal$monthly_cost <- gsub( '\\$' ,'', usda_low_cost_meal$monthly_cost )

#vector with costs
food_cost_general <-  data.frame(
adult=  mean( c(as.numeric( usda_low_cost_meal %>% filter(group=='19-50 years') %>% pull(monthly_cost) ) ) ),
infant= as.numeric( usda_low_cost_meal %>% filter(group=='1 year') %>% pull(monthly_cost) ) ,

toddler=  mean( c(as.numeric( usda_low_cost_meal %>% filter(group=='2-3 years') %>% pull(monthly_cost) ) ) ),

preschooler= mean(as.numeric(usda_low_cost_meal %>% filter(group=='4-5 years') %>% pull(monthly_cost)) ),
schooler= mean(c( as.numeric(usda_low_cost_meal %>% filter(group=='6-8 years') %>% pull(monthly_cost)) ,
                     as.numeric(usda_low_cost_meal %>% filter(group=='9-11 years') %>% pull(monthly_cost)) )),
teenager=  mean(c( as.numeric(usda_low_cost_meal %>% filter(group=='12-13 years') %>% pull(monthly_cost)) ,
                     as.numeric(usda_low_cost_meal %>% filter(group=='14-18 years') %>% pull(monthly_cost)) )) )


#ADJUSTMENTS
#AVERAGE MEAL COST IN THE UNITED STATES: $3.25. Source: Feeding America for 2020
meal_avg_cost_us <- 3.25
# Fairfax Average Meal Cost: $4.23
#meal_avg_cost_fairfax_va <- 4.23
meal_avg_cost_fairfax_va <- food_cost_adj %>% filter(geoid==county_fips) %>% filter(measure == 'Cost_Per_Meal') %>%  pull(value)
#adjustment
adj_food_cost <- meal_avg_cost_fairfax_va /meal_avg_cost_us
#food inflation - BLS to adjust meal cost from 2020
inflation_usa_food_2021 <- 0.065
inflation_usa_food_2022 <- 0.118
inflation_msa_mdv_food_2021 <- 0.057
inflation_msa_mdv_food_2022 <- 0.087

#adjustment + inflation_food adjustment
adj_food_cost_inf <- meal_avg_cost_fairfax_va/meal_avg_cost_us*(1+inflation_msa_mdv_food_2021)*(1+inflation_msa_mdv_food_2022)/((1+inflation_usa_food_2021)*(1+inflation_usa_food_2022))

#food cost adjusted by geography (county) and by inflation
food_cost_general_adj_infl <- adj_food_cost_inf*food_cost_general


#vector of per person cost - food
vector_food_cost <- data.frame(cost_pc = t(food_cost_general_adj_infl))
vector_food_cost <- tibble::rownames_to_column(vector_food_cost, "person")

#long format
food_cost_long <- hh_config  %>% select(PUMA, SERIAL, income_cat, hh_recode, adult, preschooler, toddler, schooler, teenager, infant ) %>% arrange(SERIAL) %>% pivot_longer(cols=c('adult', 'preschooler', 'toddler', 'schooler', 'teenager', 'infant'),
                    names_to='person',
                    values_to='num_person') %>% left_join(vector_food_cost, by = "person") %>% mutate(adj_econ_scales = case_when( 
                      hh_recode == 1 ~ 1 + 0.2, 
                      hh_recode == 2 ~ 1 + 0.1,
                      hh_recode == 3 ~ 1 + 0.05,
                      hh_recode == 4 ~ 1 + 0,
                      hh_recode == 5 ~ 1 - 0.05)
                      ) %>% mutate(food_cost_month = num_person*cost_pc*adj_econ_scales)


food_col_hh_actual <- food_cost_long %>% group_by(SERIAL) %>% summarise(food_cost_month = sum(food_cost_month))

```


# Healthcare Cost
```{r}
#Data households in county: age, marital status, provision of healthcare by employer
df_hh_indiv_insur <- read_csv("~/git/household_living_budget/data/household_living_budget/healthcare/fairfax_va_acs_puma_households_age_maritalstatus_2020.csv")

# HINSEMP   Health insurance through employer/union
# 1          No insurance through employer/union
# 2          Has insurance through employer/union


#Methodology: 7 steps to estimate healthcare cost for individual plans (no through employer)

#1 Percentage FPL

### Estimation WITH Premium Tax Credit -  TO BE REVISED
#federal poverty line FPL

FPL = c(12880,  17420,  21960, 26500, 31040, 35580, 40120, 44660 )
#Source: https://www.healthreformbeyondthebasics.org/wp-content/uploads/2021/09/REFERENCE-GUIDE_Yearly-Guideline-and-Thresholds_CoverageYear2022-1.pdf
#https://aspe.hhs.gov/sites/default/files/documents/175e430d7dd4b1622d7245bc8664b3c2/HHS-Poverty-Guidelines-Fed-Register-2022.pdf

df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(num_pax = adult + preschooler + toddler + schooler + teenager + infant) %>% 
  mutate(fpl_factor = case_when( num_pax == 1 ~ hhincome/FPL[1]*100,
                                 num_pax == 2 ~ hhincome/FPL[2]*100,
                                 num_pax == 3 ~ hhincome/FPL[3]*100,
                                 num_pax == 4 ~ hhincome/FPL[4]*100,
                                 num_pax == 5 ~ hhincome/FPL[5]*100,
                                 num_pax == 6 ~ hhincome/FPL[6]*100,
                                 num_pax == 7 ~ hhincome/FPL[7]*100,
                                 num_pax >= 8 ~ hhincome/FPL[8]*100
                                 )
         ) 

df_hh_indiv_insur$fpl_factor <- round(df_hh_indiv_insur$fpl_factor,0)                                                 

#2 Expected percentage
#table from IRS
form_irs_8692 <- read_excel("~/git/household_living_budget/data/household_living_budget/healthcare/usa_irs_table_form_8962.xlsx")

df_hh_indiv_insur <- df_hh_indiv_insur %>% left_join(form_irs_8692, by = c("fpl_factor"="fpl_threshold") ) %>% 
  mutate(expected_pctage = case_when( 
    fpl_factor <= 150 ~ 0,
    fpl_factor >= 400 ~ 0.085, 
    fpl_factor > 150 & fpl_factor < 400 ~ expected_pc
    ))


#3 Expected year contribution
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(exp_year_contrib = expected_pctage*hhincome, 
                                                  exp_year_contrib_month = exp_year_contrib/12 )


#4 Benchmark plan (SLCSP)
library(readxl)
#reference https://www.healthcare.gov/health-plan-information-2022/
premium_costs_mktplace <- read_excel("~/git/household_living_budget/data/household_living_budget/healthcare/usa_health_insurance_marketplace_healthcare_premiums_2022.xlsx", skip = 1)

#write_csv(premium_costs_mktplace_va, "~/git/cost-living/data/healthcare_cost_marketplace/Individual_Market_Medical_VA.xlsx")

premium_costs_mktplace_geospecific <- premium_costs_mktplace %>% 
  filter(`State Code` == 'VA') %>% 
  filter(`County Name` == 'Fairfax') %>% 
  filter( `Rating Area` == 'Rating Area 10') %>%
  filter(`Metal Level` == 'Silver') %>% 
  select(
    "State Code",
    "FIPS County Code",
    "County Name",
    "Rating Area",
    "Metal Level",
    "Plan Marketing Name",
    "Rating Area",
    "Premium Child Age 0-14",
    "Premium Child Age 18", 
    "Premium Adult Individual Age 21",
    "Premium Adult Individual Age 27", 
    "Premium Adult Individual Age 30",
    "Premium Adult Individual Age 40",
    "Premium Adult Individual Age 50",
    "Premium Adult Individual Age 60"
  ) %>% arrange(`Premium Adult Individual Age 30`) %>% 
  slice(2)

#calculate the benchmark individual plans
df_hh_indiv_insur <- df_hh_indiv_insur %>% 
  mutate(plan1 = case_when(per1 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per1 > 14 & per1 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per1 > 18 & per1 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per1 > 21 & per1 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per1 > 27 & per1 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per1 > 30 & per1 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per1 > 40 & per1 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per1 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan2 = case_when(per2 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per2 > 14 & per2 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per2 > 18 & per2 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per2 > 21 & per2 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per2 > 27 & per2 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per2 > 30 & per2 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per2 > 40 & per2 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per2 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan3 = case_when(per3 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per3 > 14 & per3 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per3 > 18 & per3 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per3 > 21 & per3 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per3 > 27 & per3 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per3 > 30 & per3 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per3 > 40 & per3 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per3 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan4 = case_when(per4 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per4 > 14 & per4 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per4 > 18 & per4 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per4 > 21 & per4 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per4 > 27 & per4 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per4 > 30 & per4 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per4 > 40 & per4 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per4 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan5 = case_when(per5 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per5 > 14 & per5 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per5 > 18 & per5 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per5 > 21 & per5 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per5 > 27 & per5 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per5 > 30 & per5 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per5 > 40 & per5 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per5 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan6 = case_when(per6 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per6 > 14 & per6 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per6 > 18 & per6 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per6 > 21 & per6 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per6 > 27 & per6 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per6 > 30 & per6 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per6 > 40 & per6 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per6 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan7 = case_when(per7 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per7 > 14 & per7 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per7 > 18 & per7 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per7 > 21 & per7 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per7 > 27 & per7 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per7 > 30 & per7 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per7 > 40 & per7 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per7 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan8 = case_when(per8 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per8 > 14 & per8 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per8 > 18 & per8 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per8 > 21 & per8 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per8 > 27 & per8 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per8 > 30 & per8 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per8 > 40 & per8 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per8 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`), 
       
       plan9 = case_when(per9 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per9 > 14 & per9 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per9 > 18 & per9 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per9 > 21 & per9 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per9 > 27 & per9 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per9 > 30 & per9 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per9 > 40 & per9 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per9 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan10 = case_when(per10 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per10 > 14 & per10 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per10 > 18 & per10 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per10 > 21 & per10 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per10 > 27 & per10 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per10 > 30 & per10 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per10 > 40 & per10 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per10 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan11 = case_when(per11 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per11 > 14 & per11 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per11 > 18 & per11 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per11 > 21 & per11 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per11 > 27 & per11 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per11 > 30 & per11 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per11 > 40 & per11 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per11 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan12 = case_when(per12 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per12 > 14 & per12 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per12 > 18 & per12 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per12 > 21 & per12 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per12 > 27 & per12 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per12 > 30 & per12 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per12 > 40 & per12 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per12 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan13 = case_when(per13 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per13 > 14 & per13 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per13 > 18 & per13 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per13 > 21 & per13 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per13 > 27 & per13 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per13 > 30 & per13 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per13 > 40 & per13 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per13 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan14 = case_when(per14 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per14 > 14 & per14 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per14 > 18 & per14 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per14 > 21 & per14 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per14 > 27 & per14 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per14 > 30 & per14 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per14 > 40 & per14 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per14 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`),
       
       plan15 = case_when(per15 <= 14 ~ premium_costs_mktplace_geospecific$`Premium Child Age 0-14`,
                         per15 > 14 & per15 <= 18 ~ premium_costs_mktplace_geospecific$`Premium Child Age 18`,
                         per15 > 18 & per15 <= 21 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 21`,
                         per15 > 21 & per15 <= 27 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 27`,
                         per15 > 27 & per15 <= 30 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 30`,
                         per15 > 30 & per15 <= 40 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 40`,
                         per15 > 40 & per15 <= 50 ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 50`,
                         per15 > 50  ~ premium_costs_mktplace_geospecific$`Premium Adult Individual Age 60`)

       )

#benchmark plan
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(benchmark_plan = rowSums(df_hh_indiv_insur[, which(names(df_hh_indiv_insur) == "plan1") : which(names(df_hh_indiv_insur) == "plan15")], na.rm=TRUE) )
           
#5 Premium Tax Credit
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(ptc = ifelse(benchmark_plan < exp_year_contrib_month, 0,  benchmark_plan - exp_year_contrib_month ) ) 
  
#6 Premium = Cost - ptc
#cost with the lowest bronze
costs_mktplace_lowest_bronze <- premium_costs_mktplace %>% 
  filter(`State Code` == 'VA') %>% 
  filter(`County Name` == 'Fairfax') %>% 
  filter( `Rating Area` == 'Rating Area 10') %>%
  filter(`Metal Level` == 'Bronze') %>% 
  select(
    "State Code",
    "FIPS County Code",
    "County Name",
    "Rating Area",
    "Metal Level",
    "Plan Marketing Name",
    "Rating Area",
    "Premium Child Age 0-14",
    "Premium Child Age 18", 
    "Premium Adult Individual Age 21",
    "Premium Adult Individual Age 27", 
    "Premium Adult Individual Age 30",
    "Premium Adult Individual Age 40",
    "Premium Adult Individual Age 50",
    "Premium Adult Individual Age 60", 
    "Medical Maximum Out Of Pocket - Individual - Standard",
    "Medical Maximum Out Of Pocket - Family - Standard" 
  ) %>% arrange(`Premium Adult Individual Age 30`) %>% 
  slice_min(`Premium Adult Individual Age 30`)

#cost with the lowest silver
costs_mktplace_lowest_silver <- premium_costs_mktplace %>% 
  filter(`State Code` == 'VA') %>% 
  filter(`County Name` == 'Fairfax') %>% 
  filter( `Rating Area` == 'Rating Area 10') %>%
  filter(`Metal Level` == 'Silver') %>% 
  select(
    "State Code",
    "FIPS County Code",
    "County Name",
    "Rating Area",
    "Metal Level",
    "Plan Marketing Name",
    "Rating Area",
    "Premium Child Age 0-14",
    "Premium Child Age 18", 
    "Premium Adult Individual Age 21",
    "Premium Adult Individual Age 27", 
    "Premium Adult Individual Age 30",
    "Premium Adult Individual Age 40",
    "Premium Adult Individual Age 50",
    "Premium Adult Individual Age 60", 
    "Medical Maximum Out Of Pocket - Individual - Standard",
    "Medical Maximum Out Of Pocket - Family - Standard" 
  ) %>% arrange(`Premium Adult Individual Age 30`) %>% 
  slice_min(`Premium Adult Individual Age 30`)



# costs_mktplace_lowest_bronze
# costs_mktplace_lowest_silver

#estimate cost of plans with lowest bronze
df_hh_indiv_insur <- df_hh_indiv_insur %>% 
  mutate(plan1_bro = case_when(per1 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per1 > 14 & per1 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per1 > 18 & per1 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per1 > 21 & per1 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per1 > 27 & per1 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per1 > 30 & per1 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per1 > 40 & per1 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per1 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan2_bro = case_when(per2 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per2 > 14 & per2 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per2 > 18 & per2 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per2 > 21 & per2 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per2 > 27 & per2 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per2 > 30 & per2 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per2 > 40 & per2 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per2 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan3_bro = case_when(per3 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per3 > 14 & per3 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per3 > 18 & per3 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per3 > 21 & per3 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per3 > 27 & per3 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per3 > 30 & per3 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per3 > 40 & per3 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per3 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan4_bro = case_when(per4 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per4 > 14 & per4 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per4 > 18 & per4 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per4 > 21 & per4 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per4 > 27 & per4 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per4 > 30 & per4 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per4 > 40 & per4 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per4 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan5_bro = case_when(per5 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per5 > 14 & per5 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per5 > 18 & per5 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per5 > 21 & per5 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per5 > 27 & per5 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per5 > 30 & per5 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per5 > 40 & per5 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per5 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan6_bro = case_when(per6 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per6 > 14 & per6 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per6 > 18 & per6 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per6 > 21 & per6 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per6 > 27 & per6 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per6 > 30 & per6 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per6 > 40 & per6 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per6 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan7_bro = case_when(per7 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per7 > 14 & per7 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per7 > 18 & per7 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per7 > 21 & per7 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per7 > 27 & per7 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per7 > 30 & per7 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per7 > 40 & per7 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per7 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan8_bro = case_when(per8 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per8 > 14 & per8 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per8 > 18 & per8 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per8 > 21 & per8 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per8 > 27 & per8 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per8 > 30 & per8 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per8 > 40 & per8 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per8 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`), 
       
       plan9_bro = case_when(per9 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per9 > 14 & per9 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per9 > 18 & per9 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per9 > 21 & per9 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per9 > 27 & per9 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per9 > 30 & per9 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per9 > 40 & per9 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per9 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan10_bro = case_when(per10 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per10 > 14 & per10 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per10 > 18 & per10 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per10 > 21 & per10 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per10 > 27 & per10 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per10 > 30 & per10 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per10 > 40 & per10 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per10 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan11_bro = case_when(per11 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per11 > 14 & per11 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per11 > 18 & per11 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per11 > 21 & per11 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per11 > 27 & per11 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per11 > 30 & per11 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per11 > 40 & per11 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per11 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan12_bro = case_when(per12 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per12 > 14 & per12 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per12 > 18 & per12 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per12 > 21 & per12 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per12 > 27 & per12 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per12 > 30 & per12 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per12 > 40 & per12 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per12 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan13_bro = case_when(per13 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per13 > 14 & per13 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per13 > 18 & per13 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per13 > 21 & per13 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per13 > 27 & per13 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per13 > 30 & per13 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per13 > 40 & per13 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per13 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan14_bro = case_when(per14 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per14 > 14 & per14 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per14 > 18 & per14 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per14 > 21 & per14 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per14 > 27 & per14 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per14 > 30 & per14 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per14 > 40 & per14 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per14 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`),
       
       plan15_bro = case_when(per15 <= 14 ~ costs_mktplace_lowest_bronze$`Premium Child Age 0-14`,
                         per15 > 14 & per15 <= 18 ~ costs_mktplace_lowest_bronze$`Premium Child Age 18`,
                         per15 > 18 & per15 <= 21 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 21`,
                         per15 > 21 & per15 <= 27 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 27`,
                         per15 > 27 & per15 <= 30 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 30`,
                         per15 > 30 & per15 <= 40 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 40`,
                         per15 > 40 & per15 <= 50 ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 50`,
                         per15 > 50  ~ costs_mktplace_lowest_bronze$`Premium Adult Individual Age 60`)

       )

#cost of bronze plan
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(cost_bronze_plan = rowSums(df_hh_indiv_insur[, which(names(df_hh_indiv_insur) == "plan1_bro") : which(names(df_hh_indiv_insur) == "plan15_bro")], na.rm=TRUE) )
  
#determine premium
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(premium_month = ifelse( cost_bronze_plan < ptc, 0, cost_bronze_plan - ptc )   )
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(premium_month2 = cost_bronze_plan - ptc)

#plot(df_hh_indiv_insur$premium_month, df_hh_indiv_insur$hhincome)

##########################
#7 Yearly Cost - with factor 
#data for factors
premium_healthcare <- read_excel("~/git/household_living_budget/data/household_living_budget/healthcare/fairfax_himarketplace_subset70_healthcare_costs_2022.xlsx", sheet = "data_complete")

#annual premium
premium_healthcare <- premium_healthcare %>% mutate(premium_year = ifelse( premium < 0, 0, premium*12 ))

#annual proportion
premium_healthcare <- premium_healthcare %>% mutate(cost_increase_factor =  `yearly cost`/premium_year )

#factors by pieces
factors <- premium_healthcare %>% group_by(income, hh_size, adult) %>% summarise(factor = mean(cost_increase_factor, na.rm = TRUE))

#percentage diff/out-pocket
premium_healthcare <- premium_healthcare %>% mutate(prop_diff =  (`yearly cost`- premium_year)/`max outpock` )

#proportion diff vs out-pocket with
#factors_prop_diff <- premium_healthcare %>% group_by(income, hh_size, adult) %>% summarise(factor = mean(prop_diff, na.rm = TRUE))
factors_prop_diff_hh_size <- premium_healthcare %>% group_by(income, hh_size) %>% summarise(factor = mean(prop_diff, na.rm = TRUE))

factors_prop_diff_hh_size <- factors_prop_diff_hh_size %>% mutate(income_cat = case_when(income == 7500 ~ 'Less than $15,000',
                                                                                         income == 20000 ~ '$15,000 to $24,999',
                                                                                         income == 30000 ~ '$25,000 to $34,999',
                                                                                         income == 42500 ~ '$35,000 to $49,999',
                                                                                         income == 62500 ~ '$50,000 to $74,999',
                                                                                         income == 87500 ~ '$75,000 to $99,999',
                                                                                         income == 125000 ~ '$100,000 to $149,999',
                                                                                         income == 175000 ~ '$150,000 to $199,999',
                                                                                         income == 225000 ~ '$200,000 or more'
                                                                                         ))
##################

#assign proportions to estimate yearly costs
df_hh_indiv_insur <- df_hh_indiv_insur %>% left_join(factors_prop_diff_hh_size %>% select(-c(income)), by= c("income_cat", "hh_recode"="hh_size"))
#plot(df_hh_indiv_insur$hhincome, df_hh_indiv_insur$factor)

#assign max out-of-pocket
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(max_out_pocket = ifelse( hh_recode == 1, costs_mktplace_lowest_bronze$`Medical Maximum Out Of Pocket - Individual - Standard`, costs_mktplace_lowest_bronze$`Medical Maximum Out Of Pocket - Family - Standard`) )

df_hh_indiv_insur$max_out_pocket <-  gsub("\\$","", as.character(df_hh_indiv_insur$max_out_pocket))
df_hh_indiv_insur$max_out_pocket <-  gsub(",","", as.character(df_hh_indiv_insur$max_out_pocket))

df_hh_indiv_insur$max_out_pocket_format <- as.numeric(df_hh_indiv_insur$max_out_pocket)

#df_hh_indiv_insur$maxoop <- df_hh_indiv_insur$factor*as.numeric(df_hh_indiv_insur$max_out_pocket)

#yearly costs :  premium_month*12 + out_of_pocket_max*factor. (factor based on low usage)
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(yearly_costs_init = premium_month*12 + factor*as.numeric(max_out_pocket), 
                                                  yearly_costs_month_init =yearly_costs_init/12 )

#adjustment for poorest cases, with possible medicaid or CHIP
min_health_month <- df_hh_indiv_insur %>% group_by(hh_recode) %>% summarise( min_health_month = min(yearly_costs_month_init, na.rm = TRUE))

#final yearly cost with adjustment for poor
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(yearly_costs =  case_when( is.na(yearly_costs_init) & hh_recode==1  ~  as.numeric(min_health_month[1, 2]),
                                                                             is.na(yearly_costs_init) & hh_recode==2  ~  as.numeric(min_health_month[2, 2]),
                                                                             is.na(yearly_costs_init) & hh_recode==3  ~  as.numeric(min_health_month[3, 2]),
                                                                             is.na(yearly_costs_init) & hh_recode==4  ~  as.numeric(min_health_month[4, 2]),
                                                                             is.na(yearly_costs_init) & hh_recode==5  ~  as.numeric(min_health_month[5 , 2]),
                                                                             !is.na(yearly_costs_init) ~ yearly_costs_init
                                                                             ) ) %>% mutate(yearly_costs_month =  yearly_costs/12)


# min(df_hh_indiv_insur$yearly_costs_month, na.rm = TRUE)
# min_health_year <- min_health_month*12


#### cost for employer sponsored
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(contrib_worker_month = case_when( HINSEMP == 1 ~  cost_bronze_plan*0.17,
                                                                              HINSEMP == 2 ~  cost_bronze_plan*0.28
                                                                              ) )
#maximum amounts to be spent as out-of-pocket
single_plan_sponsored_max_out_pocket <- 4594
family_plan_sponsored_max_out_pocket <- 8375


df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate(health_insur_with_employer_year = case_when(hh_recode == 1 & !is.na(factor) ~ contrib_worker_month*12 + factor*as.numeric(max_out_pocket),
                                                                                              hh_recode != 1 & !is.na(factor) ~ contrib_worker_month*12 + factor*as.numeric(max_out_pocket), 
                                                                                              is.na(factor) ~ yearly_costs
                                                                                              ) )


#final estimation: 
#for employer sponsored: %*contrib + % average Out-of-Pocket
#for individual plans: healthcare marketplace
df_hh_indiv_insur <- df_hh_indiv_insur %>% mutate( healthcare_cost_month = case_when(HINSEMP == 1 ~ yearly_costs/12,
                                                                                     HINSEMP == 2 ~ health_insur_with_employer_year/12)
)


# distribution healthcare cost
hist(df_hh_indiv_insur$healthcare_cost_month)

```


# Childcare Cost
```{r}
#data -  Dept of Labor
childcare_dol <- read_excel("~/git/household_living_budget/data/household_living_budget/childcare/dmv_dol_childcare_costs_2022.xlsx")
#data county
childcare_dol_county <- childcare_dol %>% filter(year==2022) %>% filter(FIPS == county_fips) %>%
  select("name_county", "FIPS", "year", "infant_family", "toddler_family", "preschooler_family", "schooler_family" )


#weekly cost
cc_cost_indiv_min <- c(
adult= 0, 
infant= childcare_dol_county %>% pull(infant_family),
toddler= childcare_dol_county %>% pull(toddler_family),
preschooler= childcare_dol_county %>% pull(preschooler_family),
schooler= childcare_dol_county %>% pull(schooler_family),
teenager=0) 

#Representative hh county
#rep_hh_community <- representative_comm
                                              
# cost of child care per representative family - min - per month
childcare_cost <-  hh_config %>% mutate(childcare_cost_month= 
                                                         as.numeric(cc_cost_indiv_min['adult'])*adult*4  +
                                                         as.numeric(cc_cost_indiv_min['teenager'])*teenager*4 +
                                                         as.numeric(cc_cost_indiv_min['schooler'])*schooler*4 +
                                                         as.numeric(cc_cost_indiv_min['preschooler'])*preschooler*4 +
                                                         as.numeric(cc_cost_indiv_min['toddler'])*toddler*4 +
                                                         as.numeric(cc_cost_indiv_min['infant'])*infant*4
                                                         )

```

#Merge with df_hlb
```{r}
#centralized data frame for household living budget
df_hlb <- hh_config

#food
df_hlb <-  df_hlb %>% left_join(food_col_hh_actual %>% select(SERIAL, food_cost_month) , by = 'SERIAL')

#healthcare
df_hlb <-  df_hlb %>% left_join(df_hh_indiv_insur %>% select(SERIAL, healthcare_cost_month) , by = 'SERIAL')

#childcare
df_hlb <- df_hlb %>% left_join( as.data.frame(childcare_cost) %>% select(SERIAL, childcare_cost_month) , by = 'SERIAL')
```



#Fill in information matrix tract-income-combinations_hh (tic)
```{r}
#df_0_actual vs (tract, puma)

#geoid AND puma
geoid_puma <- puma_ct_fairfax_20 %>% filter(COUNTYFP=="059") %>% select(geoid=fips, puma=PUMA5CE)
df_hlb$PUMA <- as.character(df_hlb$PUMA)

#joing geoid_puma with df_hlb: we are saying that the structure of every puma replicates for every census tract
df_hlb_tic <- geoid_puma %>% left_join(df_hlb %>% select(PUMA, SERIAL,income_cat, hhincome, hh_recode, hh_compos, adult, num_hh=pop, food_cost_month, healthcare_cost_month, childcare_cost_month), 
                                        by = c("puma"="PUMA"))

```


#2.2 Exercise at the tract level: housing and transportation
# Housing Cost 
```{r}
#data fro HUD
housing_cost_va_updated <- read_excel("~/git/household_living_budget/data/household_living_budget/housing/va_tr_hud_2022_housing_cost.xlsx") %>% select(-c(`...1`))

housing_cost_va_updated <- housing_cost_va_updated %>% mutate(fips=substr(geoid,1,5)) %>% filter(fips %in% counties_shared_puma )

housing_cost_va_updated_wide <- spread(housing_cost_va_updated, key = measure, value = value)

housing_cost_county <- housing_cost_va_updated_wide %>% mutate(
  `1` =  monthly_rent_0br,
  `2` =  monthly_rent_1br,
  `3` =  monthly_rent_2br,
  `4` =  monthly_rent_3br,
  `5` =  monthly_rent_4br
  ) %>% select( -c(monthly_rent_0br,monthly_rent_1br,monthly_rent_2br,monthly_rent_3br,monthly_rent_4br, measure_type, region_type, region_name, year, fips) )


#housing cost in long format
housing_cost_long <- housing_cost_county %>% pivot_longer(cols=c(`1` ,  `2`  , `3` ,  `4` ,  `5`),
                    names_to='hh_size',
                    values_to='housing_cost_month')

```


# Cost of Transportation
```{r}
#data va 2022 updated
transp_cost_va <- read_excel("~/git/household_living_budget/data/household_living_budget/transportation/va_tr_cnt_transportation_cost_2022.xlsx")

####
#create fips
transp_cost_va$fips <- substr(transp_cost_va$tract, 1, 5)

#data county per tract
transp_cost_va$tract <- as.character(transp_cost_va$tract)

transp_cost_county_tract <- transp_cost_va %>% filter(fips %in% counties_shared_puma) %>% select(tract, Transport_1) %>% 
     left_join(puma_ct_fairfax_20 %>% select(puma=PUMA5CE, fips) , by=c('tract'='fips'))

```

#Broadband cost 
```{r}
#data
dat_broadband <- read.csv("~/git/household_living_budget/data/household_living_budget/broadband/dcmdva_hdcttrbg_2021_broadband_now_internet_package_price.csv.xz")
#county id
dat_broadband$county <- substr(dat_broadband$geoid,1,5)

library(dplyr)
#use min price 25
bband_county_tr <- dat_broadband %>% filter(county %in% counties_shared_puma) %>% filter(region_type =='tract') %>% filter(measure=="min_price_25")

price_increase_wireless_service <- 0  #0.013
bband_tract <- bband_county_tr %>% mutate(broadband_cost_month = value*(1+price_increase_wireless_service)) %>% select(geoid, broadband_cost_month)

```


#Merge with df_hlb_tic
```{r}
#housing
df_hlb_tic$hh_size <-  as.character(df_hlb_tic$hh_recode)
df_hlb_tic <- df_hlb_tic %>% left_join(housing_cost_long, by = c("geoid", "hh_size") )

#transportation
df_hlb_tic <- df_hlb_tic %>% left_join(transp_cost_county_tract %>% select(tract, Transport_1), by = c("geoid"="tract") ) %>% mutate(transp_cost_month = adult*Transport_1) 
df_hlb_tic <- df_hlb_tic %>% select(-c(Transport_1))

#NAs - average by hh_size
complement_trasp <- df_hlb_tic %>% select(hh_size=hh_recode, transp_cost_month) %>% group_by(hh_size) %>% summarise(mean_transp = mean(transp_cost_month, na.rm = TRUE))

#complete NAs by hh_size
df_hlb_tic <- df_hlb_tic %>% mutate(transp_cost_month = case_when( !is.na(transp_cost_month) ~ transp_cost_month, 
                                                     is.na(transp_cost_month) & hh_size==1 ~ complement_trasp %>% filter(hh_size==1) %>% select(mean_transp) %>% pull(),
                                                     is.na(transp_cost_month) & hh_size==2 ~ complement_trasp %>% filter(hh_size==2) %>% select(mean_transp) %>% pull(),
                                                     is.na(transp_cost_month) & hh_size==3 ~ complement_trasp %>% filter(hh_size==3) %>% select(mean_transp) %>% pull(),
                                                     is.na(transp_cost_month) & hh_size==4 ~ complement_trasp %>% filter(hh_size==4) %>% select(mean_transp) %>% pull(),
                                                     is.na(transp_cost_month) & hh_size==5 ~ complement_trasp %>% filter(hh_size==5) %>% select(mean_transp) %>% pull()
                                                     ))


#broadband - internet
df_hlb_tic <- df_hlb_tic %>% left_join(bband_tract, by = c("geoid") )

#NAs - average by hh_size
complement_bband <- df_hlb_tic %>% select(hh_size=hh_recode, broadband_cost_month) %>% group_by(hh_size) %>% summarise(mean_bband = mean(broadband_cost_month, na.rm = TRUE))

#complete NAs by hh_size
df_hlb_tic <- df_hlb_tic %>% mutate(broadband_cost_month = case_when( !is.na(broadband_cost_month) ~ broadband_cost_month, 
                                                     is.na(broadband_cost_month) & hh_size==1 ~ complement_bband %>% filter(hh_size==1) %>% select(mean_bband) %>% pull(),
                                                     is.na(broadband_cost_month) & hh_size==2 ~ complement_bband %>% filter(hh_size==2) %>% select(mean_bband) %>% pull(),
                                                     is.na(broadband_cost_month) & hh_size==3 ~ complement_bband %>% filter(hh_size==3) %>% select(mean_bband) %>% pull(),
                                                     is.na(broadband_cost_month) & hh_size==4 ~ complement_bband %>% filter(hh_size==4) %>% select(mean_bband) %>% pull(),
                                                     is.na(broadband_cost_month) & hh_size==5 ~ complement_bband %>% filter(hh_size==5) %>% select(mean_bband) %>% pull()
                                                     ))

```

# Other costs
```{r}
percentage_other_expenses <- 0.2

df_hlb_tic <- df_hlb_tic %>% mutate(other_month = (food_cost_month+housing_cost_month)*percentage_other_expenses ) 
  
```

#  ######################## 3 Data set  ########################

# Save data set of HLB with information of census tracts, income category and household combinations
# With this file, proceed to sample to create the synthetic population
```{r}

#save file in 
if(!file.exists( paste0("~/git/household_living_budget/documents/products/data_tables/", name_files, "_", state_name, "_hlb_no_tax_2022.csv") )){
  
  write.csv.gz(df_hlb_tic, paste0("~/git/household_living_budget/documents/products/data_tables/", name_files, "_", state_name, "_hlb_no_tax_2022.csv") , row.names = FALSE)
}

```


